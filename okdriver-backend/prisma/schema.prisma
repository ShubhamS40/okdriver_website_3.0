generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String                @id @default(uuid())
  googleId      String?               @unique
  email         String                @unique
  name          String
  picture       String?
  emailVerified Boolean               @default(false)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  password      String?
  apiKeys       UserApiKey[]
  subscriptions UserApiSubscription[]

  @@index([googleId])
  @@index([email])
}

model UserApiKey {
  id         String    @id @default(uuid())
  userId     String
  keyName    String
  apiKey     String    @unique
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  revoked    Boolean   @default(false)
  userEmail  String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userEmail])
  @@index([apiKey])
  @@index([expiresAt])
  @@index([revoked])
}

model Driver {
  id               String               @id @default(uuid())
  firstName        String?
  lastName         String?
  email            String?              
  phone            String               @unique
  latitude         Float                @default(0)
  longitude        Float                @default(0)
  emergencyContact String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  payments         DriverPayment[]
  sessions         DriverSession[]
  subscriptions    DriverSubscription[]
}

model DriverSession {
  id           String   @id @default(uuid())
  driverId     String
  token        String   @unique
  deviceInfo   String?
  isActive     Boolean  @default(true)
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  driver       Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, isActive])
  @@index([token])
  @@index([expiresAt])
}

model DriverPlan {
  id             Int                  @id @default(autoincrement())
  name           String
  description    String?
  price          Decimal              @db.Decimal(10, 2)
  billingCycle   BillingCycle
  durationDays   Int
  benefits       String[]
  features       String[]
  storageLimitGB Int
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  payments       DriverPayment[]
  subscriptions  DriverSubscription[]
  services       DriverService[]      @relation("DriverPlanServices")
}

model DriverService {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  plans       DriverPlan[] @relation("DriverPlanServices")
}

model DriverSubscription {
  id         Int                @id @default(autoincrement())
  driverId   String
  planId     Int
  startAt    DateTime           @default(now())
  endAt      DateTime
  status     SubscriptionStatus @default(ACTIVE)
  paymentRef String?
  createdAt  DateTime           @default(now())
  driver     Driver             @relation(fields: [driverId], references: [id], onDelete: Cascade)
  plan       DriverPlan         @relation(fields: [planId], references: [id])

  @@index([driverId, status])
  @@index([endAt])
}

model DriverPayment {
  id        Int           @id @default(autoincrement())
  driverId  String
  planId    Int
  amount    Decimal       @db.Decimal(10, 2)
  status    PaymentStatus @default(PENDING)
  txnId     String
  mihpayid  String?
  createdAt DateTime      @default(now())
  driver    Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)
  plan      DriverPlan    @relation(fields: [planId], references: [id])

  @@index([driverId, status])
}

model CompanyPlan {
  id                     Int                   @id @default(autoincrement())
  name                   String
  description            String?
  price                  Decimal               @db.Decimal(10, 2)
  durationDays           Int?
  billingCycle           String?
  keyAdvantages          String[]
  vehicleLimit           Int?
  storageLimitGB         Int?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  clientLimit            Int?
  planType               PlanType              @default(SUBSCRIPTION)
  clientTopUps           ClientLimitTopUp[]
  companiesUsingThisPlan Company[]             @relation("CurrentPlanRelation")
  subscriptions          CompanySubscription[]
  vehicleTopUps          VehicleLimitTopUp[]
  features               CompanyFeature[]      @relation("CompanyPlanFeatures")
  services               CompanyService[]      @relation("CompanyPlanServices")
}

model ApiPlan {
  id            Int                   @id @default(autoincrement())
  name          String
  description   String?
  price         Decimal               @db.Decimal(10, 2)
  currency      String                @default("INR")
  features      String[]
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  daysValidity  Int
  subscriptions UserApiSubscription[]
}

model UserApiSubscription {
  id            Int                @id @default(autoincrement())
  userId        String
  planId        Int
  startAt       DateTime           @default(now())
  endAt         DateTime
  status        SubscriptionStatus @default(ACTIVE)
  createdAt     DateTime           @default(now())
  paymentAmount Decimal?           @db.Decimal(10, 2)
  paymentRef    String?
  paymentStatus PaymentStatus      @default(PENDING)
  payuMihpayid  String?
  plan          ApiPlan            @relation(fields: [planId], references: [id])
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([endAt])
}

model VehicleLimitTopUp {
  id           Int         @id @default(autoincrement())
  companyId    Int
  planId       Int
  vehicleCount Int
  purchasedAt  DateTime    @default(now())
  expiresAt    DateTime
  status       TopUpStatus @default(ACTIVE)
  paymentRef   String?
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan         CompanyPlan @relation(fields: [planId], references: [id])

  @@index([companyId, status])
  @@index([expiresAt])
}

model ClientLimitTopUp {
  id          Int         @id @default(autoincrement())
  companyId   Int
  planId      Int
  clientCount Int
  purchasedAt DateTime    @default(now())
  expiresAt   DateTime
  status      TopUpStatus @default(ACTIVE)
  paymentRef  String?
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan        CompanyPlan @relation(fields: [planId], references: [id])

  @@index([companyId, status])
  @@index([expiresAt])
}

model CompanyFeature {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  plans       CompanyPlan[] @relation("CompanyPlanFeatures")
}

model CompanyService {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  serviceType String?
  color       String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  plans       CompanyPlan[] @relation("CompanyPlanServices")
}

model CompanySubscription {
  id         Int                @id @default(autoincrement())
  companyId  Int
  planId     Int
  startAt    DateTime           @default(now())
  endAt      DateTime
  status     SubscriptionStatus @default(ACTIVE)
  paymentRef String?
  createdAt  DateTime           @default(now())
  company    Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan       CompanyPlan        @relation(fields: [planId], references: [id])

  @@index([companyId, status])
  @@index([endAt])
}

model Company {
  id                     Int                   @id @default(autoincrement())
  name                   String
  email                  String                @unique
  password               String
  type                   CompanyType           @default(OTHER)
  status                 CompanyStatus         @default(ACTIVE)
  currentPlanId          Int?
  subscriptionExpiresAt  DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  additionalClientLimit  Int                   @default(0)
  additionalVehicleLimit Int                   @default(0)
  resetToken             String?               @unique
  resetTokenExpiry       DateTime?
  sentMessages           ChatMessage[]         @relation("CompanySender")
  clients                Client[]
  clientChats            ClientChat[]
  clientTopUps           ClientLimitTopUp[]
  ClientList             ClientList[]
  grants                 ClientVehicleAccess[]
  currentPlan            CompanyPlan?          @relation("CurrentPlanRelation", fields: [currentPlanId], references: [id])
  subscriptions          CompanySubscription[]
  tickets                HelpSupportTicket[]
  vehicles               Vehicle[]
  vehicleChats           VehicleChat[]
  vehicleTopUps          VehicleLimitTopUp[]

  @@index([currentPlanId])
}

model Vehicle {
  id             Int                   @id @default(autoincrement())
  vehicleNumber  String                @unique
  password       String
  model          String?
  status         VehicleStatus         @default(ACTIVE)
  companyId      Int
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  type           String?
  lastLat        Decimal?              @db.Decimal(10, 7)
  lastLng        Decimal?              @db.Decimal(10, 7)
  lastLocationAt DateTime?
  chats          ChatMessage[]
  accesses       ClientVehicleAccess[]
  company        Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicleChats   VehicleChat[]
  locations      VehicleLocation[]

  @@index([companyId, status])
  @@index([lastLocationAt])
}

model VehicleLocation {
  id         Int      @id @default(autoincrement())
  vehicleId  Int
  lat        Decimal  @db.Decimal(10, 7)
  lng        Decimal  @db.Decimal(10, 7)
  speedKph   Decimal? @db.Decimal(6, 2)
  headingDeg Int?
  recordedAt DateTime @default(now())
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, recordedAt])
}

model Client {
  id               Int                   @id @default(autoincrement())
  companyId        Int
  name             String?
  email            String                @unique
  createdAt        DateTime              @default(now())
  sentMessages     ChatMessage[]         @relation("ClientSender")
  company          Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clientChats      ClientChat[]
  ClientListMember ClientListMember[]
  accesses         ClientVehicleAccess[]
}

model ClientVehicleAccess {
  id        Int      @id @default(autoincrement())
  companyId Int
  clientId  Int
  vehicleId Int
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([clientId, vehicleId])
  @@index([companyId])
}

model ClientList {
  id        Int                @id @default(autoincrement())
  companyId Int
  name      String
  createdAt DateTime           @default(now())
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members   ClientListMember[]

  @@unique([companyId, name])
  @@index([companyId])
}

model ClientListMember {
  id           Int        @id @default(autoincrement())
  clientListId Int
  clientId     Int
  createdAt    DateTime   @default(now())
  client       Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  list         ClientList @relation(fields: [clientListId], references: [id], onDelete: Cascade)

  @@unique([clientListId, clientId])
  @@index([clientId])
}

model ChatMessage {
  id              Int        @id @default(autoincrement())
  vehicleId       Int
  senderType      SenderType
  senderCompanyId Int?
  senderClientId  Int?
  message         String
  createdAt       DateTime   @default(now())
  senderClient    Client?    @relation("ClientSender", fields: [senderClientId], references: [id])
  senderCompany   Company?   @relation("CompanySender", fields: [senderCompanyId], references: [id])
  vehicle         Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, createdAt])
  @@index([senderCompanyId])
  @@index([senderClientId])
}

model VehicleChat {
  id            Int        @id @default(autoincrement())
  vehicleId     Int
  companyId     Int
  senderType    SenderType
  message       String
  attachmentUrl String?
  isRead        Boolean    @default(false)
  createdAt     DateTime   @default(now())
  company       Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicle       Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, createdAt])
  @@index([companyId, createdAt])
  @@index([isRead])
}

model ClientChat {
  id            Int        @id @default(autoincrement())
  clientId      Int
  companyId     Int
  senderType    SenderType
  message       String
  attachmentUrl String?
  isRead        Boolean    @default(false)
  createdAt     DateTime   @default(now())
  client        Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company       Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([clientId, createdAt])
  @@index([companyId, createdAt])
  @@index([isRead])
}

model HelpSupportTicket {
  id            Int            @id @default(autoincrement())
  companyId     Int
  subject       String
  description   String
  priority      TicketPriority @default(MEDIUM)
  status        TicketStatus   @default(OPEN)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  adminResponse String?
  resolvedAt    DateTime?
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([createdAt])
}

model OTP {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@index([expiresAt])
}

enum CompanyType {
  FLEET_OPERATOR
  ENTERPRISE
  UNIVERSITY
  SCHOOL
  COLLEGE
  OTHER
}

enum CompanyStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
}

enum SenderType {
  COMPANY
  DRIVER
  CLIENT
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ApiTxnType {
  CREDIT
  DEBIT
}

enum ApiTxnStatus {
  PENDING
  SUCCESS
  FAILED
}

enum BillingCycle {
  DAILY
  MONTHLY
  THREE_MONTHS
  YEARLY
  CUSTOM
}

enum PlanType {
  SUBSCRIPTION
  VEHICLE_LIMIT
  CLIENT_LIMIT
}

enum TopUpStatus {
  ACTIVE
  EXPIRED
  USED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}
